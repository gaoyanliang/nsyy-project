import json
from datetime import datetime
from flask import Blueprint, jsonify, request, Response
from collections import OrderedDict

from gylmodules.medical_record_analysis import parse_server as parse_server

parse = Blueprint('medical record analysis', __name__, url_prefix='/parse')


@parse.route('/query_record_and_parse', methods=['POST'])
def query_record_and_parse():
    try:
        json_data = json.loads(request.get_data().decode('utf-8'))
        print(json_data)
        cda, structure = parse_server.query_record_and_parse(json_data)
    except Exception as e:
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        print(f"[{timestamp}] Exception occurred: {e.__str__()}", 'param: ', json_data)
        return jsonify({
            'code': 50000,
            'res': e.__str__()
        })

    ordered_data = convert_to_ordered_dict(structure)
    ret = {
        'code': 20000,
        'cda': cda,
        'structure': ordered_data
    }
    return Response(response=json.dumps(ret, ensure_ascii=False), mimetype='application/json')
    # return Response(cda, mimetype='application/xml')


@parse.route('/get_xml', methods=['GET', 'POST'])
def get_xml():
    # XML 数据，包含特殊字符 \n, \t
    xml_data = """
<?xml version=\"1.0\" ?>\n<ClinicalDocument xmlns=\"urn:hl7-org:v3\" xmlns:mif=\"urn:hl7-org:v3/mif\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"urn:hl7-org:v3..\\sdschemas\\SDA.xsd\">\n\t<!-- ************************ Header ************************ -->\n\t<realmCode code=\"CN\"/>\n\t<typeld extension=\"POCD_MT000040\" root=\"2.16.840.1.113883.1.3\"/>\n\t<templateId root=\"2.16.156.10011.2.1.1.57\"/>\n\t<!-- 文档流水号 -->\n\t<id extension=\"nsyy001\" root=\"2.16.156.10011.1.1\"/>\n\t<code code=\"C0037\" codeSystem=\"2.16.156.10011.2.4\" codeSystemName=\"卫生信息共享文档编码体系\"/>\n\t<title>首次病程记录</title>\n\t<!--文档机器生成时间 -->\n\t<effectiveTime value=\"20240729160649\"/>\n\t<confidentialityCode code=\"N\" codeSystem=\"2.16.840.1.113883.5.25\" codeSystemName=\"Confidentiality\" displayName=\"正常访问保密级别\"/>\n\t<languageCode code=\"zh-CN\"/>\n\t<setId/>\n\t<versionNumber/>\n\t<!-- 文档记录对象（患者） -->\n\t<recordTarget contextControlCode=\"OP\" typeCode=\"RCT\">\n\t\t<patientRole classCode=\"PAT\">\n\t\t\t<!-- 住院号标识 具体的编号放入 extension -->\n\t\t\t<id extension=\"313324\" root=\"2.16.156.10011.1.12\"/>\n\t\t\t<patient classCode=\"PSN\" determinerCode=\"INSTANCE\">\n\t\t\t\t<!-- 患者身份证号 -->\n\t\t\t\t<id extension=\"41292219790923531X\" root=\"2.16.156.10011.1.3\"/>\n\t\t\t\t<name>尹新喜</name>\n\t\t\t\t<administrativeGenderCode code=\"1\" codeSystem=\"2.16.156.10011.2.3.3.4\" codeSystemName=\"生理性别代码表(GB/T2261.1)\" displayName=\"男\"/>\n\t\t\t\t<!--1 数据集里是年龄（年）、年龄（月） -->\n\t\t\t\t<birthTime value=\"19790923\"/>\n\t\t\t\t<!-- 年龄 -->\n\t\t\t\t<age unit=\"岁\" value=\"44岁\"/>\n\t\t\t</patient>\n\t\t</patientRole>\n\t</recordTarget>\n\t<!-- 文档创作者 -->\n\t<author contextControlCode=\"OP\" typeCode=\"AUT\">\n\t\t<time value=\"20240729160649\" xsi:type=\"TS\"/>\n\t\t<assignedAuthor classCode=\"ASSIGNED\">\n\t\t\t<id extension=\"0000\" root=\"2.16.156.10011.1.7\"/>\n\t\t\t<assignedPerson>\n\t\t\t\t<name>南阳南石医院</name>\n\t\t\t</assignedPerson>\n\t\t</assignedAuthor>\n\t</author>\n\t<!-- 保管机构 -->\n\t<custodian typeCode=\"CST\">\n\t\t<assignedCustodian classCode=\"ASSIGNED\">\n\t\t\t<representedCustodianOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">\n\t\t\t\t<id extension=\"0000\" root=\"2.16.156.10011.1.5\"/>\n\t\t\t\t<name>南阳南石医院</name>\n\t\t\t</representedCustodianOrganization>\n\t\t</assignedCustodian>\n\t</custodian>\n\t<!-- 最终审核者签名 -->\n\t<legalAuthenticator>\n\t\t<time/>\n\t\t<signatureCode/>\n\t\t<assignedEntity>\n\t\t\t<id extension=\"/\" root=\"2.16.156.10011.1.4\"/>\n\t\t\t<code displayName=\"上级医师\"/>\n\t\t\t<assignedPerson>\n\t\t\t\t<name>/</name>\n\t\t\t</assignedPerson>\n\t\t</assignedEntity>\n\t</legalAuthenticator>\n\t<!-- 接诊医师签名/住院医师签名/主治医师签名 -->\n\t<authenticator>\n\t\t<time/>\n\t\t<signatureCode/>\n\t\t<assignedEntity>\n\t\t\t<id extension=\"/\" root=\"2.16.156.10011.1.4\"/>\n\t\t\t<code displayName=\"住院医师\"/>\n\t\t\t<assignedPerson>\n\t\t\t\t<name>谢勇</name>\n\t\t\t</assignedPerson>\n\t\t</assignedEntity>\n\t</authenticator>\n\t<relatedDocument typeCode=\"RPLC\">\n\t\t<parentDocument>\n\t\t\t<id/>\n\t\t\t<setId/>\n\t\t\t<versionNumber/>\n\t\t</parentDocument>\n\t</relatedDocument>\n\t<!-- 病床号、病房、病区、科室和医院的关联 -->\n\t<componentOf>\n\t\t<encompassingEncounter>\n\t\t\t<!-- 入院日期时间 DE06.00.092.00 -->\n\t\t\t<effectiveTime value=\"Mon, 29 Jul 2024 12:22:00 GMT\"/>\n\t\t\t<location>\n\t\t\t\t<healthCareFacility>\n\t\t\t\t\t<serviceProviderOrganization>\n\t\t\t\t\t\t<asOrganizationPartOf classCode=\"PART\">\n\t\t\t\t\t\t\t<!-- DE01.00.026.00 病床号 -->\n\t\t\t\t\t\t\t<wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">\n\t\t\t\t\t\t\t\t<id extension=\"17\" root=\"2.16.156.10011.1.22\"/>\n\t\t\t\t\t\t\t\t<name>17</name>\n\t\t\t\t\t\t\t\t<!-- DE01.00.019.00 病房号 -->\n\t\t\t\t\t\t\t\t<asOrganizationPartOf classCode=\"PART\">\n\t\t\t\t\t\t\t\t\t<wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">\n\t\t\t\t\t\t\t\t\t\t<id extension=\"/\" root=\"2.16.156.10011.1.21\"/>\n\t\t\t\t\t\t\t\t\t\t<name>/</name>\n\t\t\t\t\t\t\t\t\t\t<!-- DE08.10.026.00   科室名称 -->\n\t\t\t\t\t\t\t\t\t\t<asOrganizationPartOf classCode=\"PART\">\n\t\t\t\t\t\t\t\t\t\t\t<wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">\n\t\t\t\t\t\t\t\t\t\t\t\t<id extension=\"170\" root=\"2.16.156.10011.1.26\"/>\n\t\t\t\t\t\t\t\t\t\t\t\t<name>/</name>\n\t\t\t\t\t\t\t\t\t\t\t\t<!-- DE08.10.054.00 病区名称 -->\n\t\t\t\t\t\t\t\t\t\t\t\t<asOrganizationPartOf classCode=\"PART\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<id extension=\"/\" root=\"2.16.156.10011.1.27\"/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<name>/</name>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<!-- XXX医院 -->\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<asOrganizationPartOf classCode=\"PART\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<wholeOrganization classCode=\"ORG\" determinerCode=\"MINSTANCE\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<id extension=\"0000\" root=\"2.16.156.10011.1.5\"/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<name>南阳南石医院</name>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</wholeOrganization>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</asOrganizationPartOf>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</wholeOrganization>\n\t\t\t\t\t\t\t\t\t\t\t\t</asOrganizationPartOf>\n\t\t\t\t\t\t\t\t\t\t\t</wholeOrganization>\n\t\t\t\t\t\t\t\t\t\t</asOrganizationPartOf>\n\t\t\t\t\t\t\t\t\t</wholeOrganization>\n\t\t\t\t\t\t\t\t</asOrganizationPartOf>\n\t\t\t\t\t\t\t</wholeOrganization>\n\t\t\t\t\t\t</asOrganizationPartOf>\n\t\t\t\t\t</serviceProviderOrganization>\n\t\t\t\t</healthCareFacility>\n\t\t\t</location>\n\t\t</encompassingEncounter>\n\t</componentOf>\n\t<component>\n\t\t<structuredBody>\n\t\t\t<!-- 主诉章节 -->\n\t\t\t<component>\n\t\t\t\t<section>\n\t\t\t\t\t<code code=\"10154-3\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\" displayName=\"CHIEF COMPLAINT\"/>\n\t\t\t\t\t<text/>\n\t\t\t\t\t<!-- 主诉条目 -->\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE04.01.119.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"主诉\"/>\n\t\t\t\t\t\t\t<value xsi:type=\"ST\">”为主诉。以“脑梗死”收住入院。</value>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t</section>\n\t\t\t</component>\n\t\t\t<!-- 诊断章节章节 -->\n\t\t\t<component>\n\t\t\t\t<section>\n\t\t\t\t\t<code code=\"29548-5\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\" displayName=\"Diagnosis\"/>\n\t\t\t\t\t<text/>\n\t\t\t\t\t<!-- 诊断章节条目 -->\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.10.133.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"病例特点\"/>\n\t\t\t\t\t\t\t<value xsi:type=\"ST\">:1</value>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE02.10.028.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"中医“四诊”观察结果\"/>\n\t\t\t\t\t\t\t<value value=\"/\" xsi:type=\"TS\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.01.070.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"诊断依据\"/>\n\t\t\t\t\t\t\t<value value=\":定位：右侧椎体束，依据：左侧肢体无力；定性：缺血性脑血管病：1、中年男性，静态卒中样起病。2、既往“脑梗死、高血压”病史。3、中枢性偏瘫；\" xsi:type=\"TS\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.01.024.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"初步诊断-西医诊断编码\"/>\n\t\t\t\t\t\t\t<value code=\"/\" codeSystem=\"2.16.156.10011.2.3.3.11.3\" codeSystemName=\"ICD-10 诊断编码表\" displayName=\"1、脑梗死右侧颈内动脉系统TOAST分型：大动脉粥样硬化型；2、多发性脑梗死；3、脑动脉狭窄；4、高血压病3级很高危组；5、2型糖尿病；6、慢性鼻窦炎。\" xsi:type=\"CD\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.10.130.00\" codeSystem=\"2.16.156.10011.2.2.1\" codesystemName=\" 卫生信息数据元目录\" displayName=\"初步诊断-中医病名代码\">\n\t\t\t\t\t\t\t\t<qualifier>\n\t\t\t\t\t\t\t\t\t<name displayName=\"中医病名代码\">\n        </name>\n\t\t\t\t\t\t\t\t</qualifier>\n\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t<value code=\"/\" codeSystem=\"2.16.156.10011.2.3.3.11.3\" codeSystemName=\"ICD-10 诊断编码表\" displayName=\"1、脑梗死右侧颈内动脉系统TOAST分型：大动脉粥样硬化型；2、多发性脑梗死；3、脑动脉狭窄；4、高血压病3级很高危组；5、2型糖尿病；6、慢性鼻窦炎。\" xsi:type=\"CD\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.10.130.00\" codeSystem=\"2.16.156.10011.2.2.1\" codesystemName=\" 卫生信息数据元目录\" displayName=\"初步诊断-中医证候代码\">\n\t\t\t\t\t\t\t\t<qualifier>\n\t\t\t\t\t\t\t\t\t<name displayName=\"中医证候代码\">\n        </name>\n\t\t\t\t\t\t\t\t</qualifier>\n\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t<value code=\"/\" codeSystem=\"2.16.156.10011.2.3.3.11.3\" codeSystemName=\"ICD-10 诊断编码表\" displayName=\"/\" xsi:type=\"CD\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.01.025.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"鉴别诊断-西医诊断名称\"/>\n\t\t\t\t\t\t\t<value value=\":与高血压性脑出血相鉴别：后者多见于老年人，既往多有'高血压'病史，多有急性颅高压症状，头颅CT可见高密度影改变，综合以上可鉴别。\" xsi:type=\"TS\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.10.172.00\" codeSystem=\"2.16.156.10011.2.2.1\" codesystemName=\" 卫生信息数据元目录\" displayName=\"鉴别诊断-中医病名名称\">\n\t\t\t\t\t\t\t\t<qualifier>\n\t\t\t\t\t\t\t\t\t<name displayName=\"中医病名名称\">\n        </name>\n\t\t\t\t\t\t\t\t</qualifier>\n\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t<value value=\":与高血压性脑出血相鉴别：后者多见于老年人，既往多有'高血压'病史，多有急性颅高压症状，头颅CT可见高密度影改变，综合以上可鉴别。\" xsi:type=\"TS\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.10.172.00\" codeSystem=\"2.16.156.10011.2.2.1\" codesystemName=\" 卫生信息数据元目录\" displayName=\"鉴别诊断-中医证候名称\">\n\t\t\t\t\t\t\t\t<qualifier>\n\t\t\t\t\t\t\t\t\t<name displayName=\"中医证候名称\">\n        </name>\n\t\t\t\t\t\t\t\t</qualifier>\n\t\t\t\t\t\t\t</code>\n\t\t\t\t\t\t\t<value value=\"/\" xsi:type=\"TS\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t</section>\n\t\t\t</component>\n\t\t\t<!-- 治疗计划章节章节 -->\n\t\t\t<component>\n\t\t\t\t<section>\n\t\t\t\t\t<code code=\"18776-5\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\" displayName=\"TREATMENT PLAN\"/>\n\t\t\t\t\t<text/>\n\t\t\t\t\t<!-- 治疗计划章节条目 -->\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE05.01.025.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"诊疗计划\"/>\n\t\t\t\t\t\t\t<value xsi:type=\"ST\">1、完善相关辅助检查（血液生化及颅内外相关检查）；2、抗血小板聚集（阿司匹林肠溶片）；降脂稳定斑块（阿托伐他汀钙片）；3.患者血液运行失常，血液淤滞，阻滞脑窍，舌质暗，舌下脉络迂曲，脉弦涩，证属气滞血瘀证，给予血栓通注射液活血化瘀通络。4、改善脑部循环（己酮可可碱注射液）；5、监测控制血压、血糖；6、对症治疗；7、请上级医师查看病人。</value>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t\t<entry>\n\t\t\t\t\t\t<observation classCode=\"OBS\" moodCode=\"EVN\">\n\t\t\t\t\t\t\t<code code=\"DE06.00.300.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"治则治法\"/>\n\t\t\t\t\t\t\t<value value=\"/\" xsi:type=\"TS\"/>\n\t\t\t\t\t\t</observation>\n\t\t\t\t\t</entry>\n\t\t\t\t</section>\n\t\t\t</component>\n\t\t</structuredBody>\n\t</component>\n</ClinicalDocument>"
"""
    return jsonify({"xmlData": xml_data})




def convert_to_ordered_dict(data):
    if isinstance(data, dict):
        return OrderedDict((k, convert_to_ordered_dict(v)) for k, v in data.items())
    elif isinstance(data, list):
        return [convert_to_ordered_dict(item) for item in data]
    else:
        return data
